---
import Button from "@/components/Button.astro";
import { db, languages as Languages, user_languages as UserLanguages, eq } from "astro:db";

interface Props {
  userId: number;
  error?: string;
}

const { userId, error } = Astro.props as Props;

// Fetch languages data
const languages = await db.select().from(Languages);
const userLanguages = await db
  .select()
  .from(UserLanguages)
  .where(eq(UserLanguages.user_id, userId));
---

<section class="space-y-4">
  <h2 class="text-xl font-semibold">Languages</h2>
  {error && <div class="p-3 bg-red-100 text-red-800 rounded border border-red-300">Error: {error}</div>}
  <form method="post" class="flex gap-3 items-end">
    <input type="hidden" name="_action" value="add_language" />
    <div class="flex-1">
      <label for="language_id" class="text-sm">Select language</label>
      <select
        id="language_id"
        name="language_id"
        class="w-full rounded border px-3 py-2"
      >
        {
          languages.map((l) => (
            <option value={String(l.id)}>
              {l.language} ({l.abbr})
            </option>
          ))
        }
      </select>
    </div>
    <Button type="submit" variant="primary">Add language</Button>
  </form>
  <ul class="flex flex-wrap gap-2">
    {
      userLanguages.map((ul) => {
        const lang = languages.find((l) => l.id === ul.language_id);
        return (
          <li class="px-3 py-1 rounded border flex items-center gap-2">
            <span>
              {lang ? `${lang.language} (${lang.abbr})` : `#${ul.language_id}`}
            </span>
            <form method="post">
              <input type="hidden" name="_action" value="delete_language" />
              <input type="hidden" name="id" value={String(ul.id)} />
              <button
                class="text-red-600"
                aria-label={
                  lang
                    ? `Remove language ${lang.language}`
                    : `Remove language #${ul.language_id}`
                }
              >
                Ã—
              </button>
            </form>
          </li>
        );
      })
    }
  </ul>
</section>
