---
import "@/styles/global.css";
import { db, users as Users, eq } from "astro:db";
import { handleAdminUserPost } from "@/lib/adminUserActions";
import AdminLayout from "@/layouts/AdminLayout.astro";
import BasicSection from "@/components/sections/BasicSection.astro";
import PersonalInfoSection from "@/components/sections/PersonalInfoSection.astro";
import EducationSection from "@/components/sections/EducationSection.astro";
import ExperienceSection from "@/components/sections/ExperienceSection.astro";
import CertificatesSection from "@/components/sections/CertificatesSection.astro";
import ProjectsSection from "@/components/sections/ProjectsSection.astro";
import SkillsSection from "@/components/sections/SkillsSection.astro";
import LanguagesSection from "@/components/sections/LanguagesSection.astro";

const userId = Number(Astro.params.id);
const [userRow] = await db.select().from(Users).where(eq(Users.id, userId));

// Fetch only the user row to verify existence
if (!userRow) {
  return Astro.redirect("/admin/users");
}

// Handle POST actions (create/update/delete)
let postError: { action: string; error?: string } | undefined;
if (Astro.request.method === "POST") {
  const form = await Astro.request.formData();
  try {
    const result = await handleAdminUserPost(userId, form);
    if (result.error) {
      postError = result;
    } else {
      return Astro.redirect(Astro.url.pathname);
    }
  } catch (e) {
    console.error(e);
    postError = {
      action: String(form.get("_action") || "unknown"),
      error: "An unexpected error occurred",
    };
  }
}

// Get the active tab from URL search params or default to 'basic'
const activeTab = Astro.url.searchParams.get("tab") || "basic";
// Determine active tab based on post error if applicable
let errorTab = activeTab;
if (postError) {
  switch (postError.action) {
    case "update_user_basic":
      errorTab = "basic";
      break;
    case "upsert_personal_info":
      errorTab = "personal";
      break;
    case "add_education":
    case "delete_education":
      errorTab = "education";
      break;
    case "add_experience":
    case "delete_experience":
      errorTab = "experience";
      break;
    case "add_certificate":
    case "delete_certificate":
      errorTab = "certificates";
      break;
    case "add_project":
    case "delete_project":
      errorTab = "projects";
      break;
    case "add_skill":
    case "delete_skill":
      errorTab = "skills";
      break;
    case "add_language":
    case "delete_language":
      errorTab = "languages";
      break;
  }
}
const finalTab = postError ? errorTab : activeTab;
---

<AdminLayout title="User #{userRow.id}">
  <div class="p-6 max-w-5xl mx-auto">
    <div class="mb-6 flex items-center justify-between">
      <h1 class="text-2xl font-semibold">Manage user #{userRow.id}</h1>
      <a href="/admin/users" class="text-fg-link hover:underline"
        >Back to users</a
      >
    </div>

    <!-- Tab Navigation -->
    <div class="border-b border-bg-subtle mb-8">
      <nav class="-mb-px flex space-x-8" aria-label="Tabs">
        <a
          href="?tab=basic"
          class={`py-4 px-1 border-b-2 font-medium text-sm ${finalTab === "basic" ? "border-primary-500 text-primary-600" : "border-transparent text-fg-subtle hover:text-fg-base hover:border-fg-muted"}`}
          >Basic Info</a
        >
        <a
          href="?tab=personal"
          class={`py-4 px-1 border-b-2 font-medium text-sm ${finalTab === "personal" ? "border-primary-500 text-primary-600" : "border-transparent text-fg-subtle hover:text-fg-base hover:border-fg-muted"}`}
          >Personal Info</a
        >
        <a
          href="?tab=education"
          class={`py-4 px-1 border-b-2 font-medium text-sm ${finalTab === "education" ? "border-primary-500 text-primary-600" : "border-transparent text-fg-subtle hover:text-fg-base hover:border-fg-muted"}`}
          >Education</a
        >
        <a
          href="?tab=experience"
          class={`py-4 px-1 border-b-2 font-medium text-sm ${finalTab === "experience" ? "border-primary-500 text-primary-600" : "border-transparent text-fg-subtle hover:text-fg-base hover:border-fg-muted"}`}
          >Experience</a
        >
        <a
          href="?tab=certificates"
          class={`py-4 px-1 border-b-2 font-medium text-sm ${finalTab === "certificates" ? "border-primary-500 text-primary-600" : "border-transparent text-fg-subtle hover:text-fg-base hover:border-fg-muted"}`}
          >Certificates</a
        >
        <a
          href="?tab=projects"
          class={`py-4 px-1 border-b-2 font-medium text-sm ${finalTab === "projects" ? "border-primary-500 text-primary-600" : "border-transparent text-fg-subtle hover:text-fg-base hover:border-fg-muted"}`}
          >Projects</a
        >
        <a
          href="?tab=skills"
          class={`py-4 px-1 border-b-2 font-medium text-sm ${finalTab === "skills" ? "border-primary-500 text-primary-600" : "border-transparent text-fg-subtle hover:text-fg-base hover:border-fg-muted"}`}
          >Skills</a
        >
        <a
          href="?tab=languages"
          class={`py-4 px-1 border-b-2 font-medium text-sm ${finalTab === "languages" ? "border-primary-500 text-primary-600" : "border-transparent text-fg-subtle hover:text-fg-base hover:border-fg-muted"}`}
          >Languages</a
        >
      </nav>
    </div>

    <!-- Tab Content -->
    <div class="space-y-6">
      {
        finalTab === "basic" && (
          <BasicSection
            userRow={userRow}
            error={
              postError && postError.action === "update_user_basic"
                ? postError.error
                : undefined
            }
          />
        )
      }
      {
        finalTab === "personal" && (
          <PersonalInfoSection
            userId={userId}
            error={
              postError && postError.action === "upsert_personal_info"
                ? postError.error
                : undefined
            }
          />
        )
      }
      {
        finalTab === "education" && (
          <EducationSection
            userId={userId}
            error={
              postError &&
              (postError.action === "add_education" ||
                postError.action === "delete_education")
                ? postError.error
                : undefined
            }
          />
        )
      }
      {
        finalTab === "experience" && (
          <ExperienceSection
            userId={userId}
            error={
              postError &&
              (postError.action === "add_experience" ||
                postError.action === "delete_experience")
                ? postError.error
                : undefined
            }
          />
        )
      }
      {
        finalTab === "certificates" && (
          <CertificatesSection
            userId={userId}
            error={
              postError &&
              (postError.action === "add_certificate" ||
                postError.action === "delete_certificate")
                ? postError.error
                : undefined
            }
          />
        )
      }
      {
        finalTab === "projects" && (
          <ProjectsSection
            userId={userId}
            error={
              postError &&
              (postError.action === "add_project" ||
                postError.action === "delete_project")
                ? postError.error
                : undefined
            }
          />
        )
      }
      {
        finalTab === "skills" && (
          <SkillsSection
            userId={userId}
            error={
              postError &&
              (postError.action === "add_skill" ||
                postError.action === "delete_skill")
                ? postError.error
                : undefined
            }
          />
        )
      }
      {
        finalTab === "languages" && (
          <LanguagesSection
            userId={userId}
            error={
              postError &&
              (postError.action === "add_language" ||
                postError.action === "delete_language")
                ? postError.error
                : undefined
            }
          />
        )
      }
    </div>
  </div>
</AdminLayout>
