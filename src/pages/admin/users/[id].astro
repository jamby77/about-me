---
import "@/styles/global.css";
import { db, users as Users, eq } from "astro:db";
import { handleAdminUserPost } from "@/lib/admin";
import AdminLayout from "@/layouts/AdminLayout.astro";
import BasicSection from "@/components/sections/BasicSection.astro";
import PersonalInfoSection from "@/components/sections/PersonalInfoSection.astro";
import EducationSection from "@/components/sections/EducationSection.astro";
import ExperienceSection from "@/components/sections/ExperienceSection.astro";
import CertificatesSection from "@/components/sections/CertificatesSection.astro";
import ProjectsSection from "@/components/sections/ProjectsSection.astro";
import SkillsSection from "@/components/sections/SkillsSection.astro";
import LanguagesSection from "@/components/sections/LanguagesSection.astro";
import TabLink from "@/components/TabLink.astro";

const userId = Number(Astro.params.id);
const [userRow] = await db.select().from(Users).where(eq(Users.id, userId));

// Fetch only the user row to verify existence
if (!userRow) {
  return Astro.redirect("/admin/users");
}

// Handle POST actions (create/update/delete)
let postError: { action: string; error?: string } | undefined;
// Capture current tab to preserve after successful POST
const redirectTab = Astro.url.searchParams.get("tab") || "basic";
if (Astro.request.method === "POST") {
  // Content-Length guard to avoid buffering huge requests
  const MAX_BODY = 6 * 1024 * 1024; // 6MB to account for multipart overhead (file max is 5MB)
  const clHeader = Astro.request.headers.get("content-length");
  const cl = clHeader ? Number(clHeader) : 0;
  if (Number.isFinite(cl) && cl > MAX_BODY) {
    // Route error to the most likely tab based on current ?tab
    const tab = redirectTab;
    const action = tab === "projects" ? "upload_project_image" : "upload_user_image";
    postError = { action, error: "File too large (max 5MB)" };
  } else {
  const form = await Astro.request.formData();
  try {
    const result = await handleAdminUserPost(userId, form);
    if (result.error) {
      postError = result;
    } else {
      return Astro.redirect(`${Astro.url.pathname}?tab=${redirectTab}`);
    }
  } catch (e) {
    console.error(e);
    postError = {
      action: String(form.get("_action") || "unknown"),
      error: "An unexpected error occurred",
    };
  }
  }
}

// Get the active tab from URL search params or default to 'basic'
const activeTab = Astro.url.searchParams.get("tab") || "basic";
// Determine active tab based on post error if applicable
let errorTab = activeTab;
if (postError) {
  switch (postError.action) {
    case "update_user_basic":
      errorTab = "basic";
      break;
    case "upsert_personal_info":
      errorTab = "personal";
      break;
    case "upload_user_image":
      errorTab = "personal";
      break;
    case "add_education":
    case "update_education":
    case "delete_education":
      errorTab = "education";
      break;
    case "add_experience":
    case "update_experience":
    case "delete_experience":
      errorTab = "experience";
      break;
    case "add_certificate":
    case "update_certificate":
    case "delete_certificate":
      errorTab = "certificates";
      break;
    case "add_project":
    case "update_project":
    case "delete_project":
    case "upload_project_image":
      errorTab = "projects";
      break;
    case "add_skill":
    case "delete_skill":
      errorTab = "skills";
      break;
    case "add_language":
    case "delete_language":
      errorTab = "languages";
      break;
  }
}
const finalTab = postError ? errorTab : activeTab;
---

<AdminLayout title=`User #${userRow.id}`>
  <div class="p-6 max-w-5xl mx-auto">
    <div class="mb-6 flex items-center justify-between">
      <h1 class="text-2xl font-semibold">Manage user #{userRow.id}</h1>
      <a href="/admin/users" class="text-fg-link hover:underline"
        >Back to users</a
      >
    </div>

    <!-- Tab Navigation -->
    <div class="border-b border-bg-subtle mb-8">
      <nav class="-mb-px flex space-x-8" aria-label="Tabs">
        <TabLink href="?tab=basic" active={finalTab === "basic"}>Basic Info</TabLink>
        <TabLink href="?tab=personal" active={finalTab === "personal"}>Personal Info</TabLink>
        <TabLink href="?tab=education" active={finalTab === "education"}>Education</TabLink>
        <TabLink href="?tab=experience" active={finalTab === "experience"}>Experience</TabLink>
        <TabLink href="?tab=certificates" active={finalTab === "certificates"}>Certificates</TabLink>
        <TabLink href="?tab=projects" active={finalTab === "projects"}>Projects</TabLink>
        <TabLink href="?tab=skills" active={finalTab === "skills"}>Skills</TabLink>
        <TabLink href="?tab=languages" active={finalTab === "languages"}>Languages</TabLink>
      </nav>
    </div>

    <!-- Tab Content -->
    <div class="space-y-6">
      {
        finalTab === "basic" && (
          <BasicSection
            userRow={userRow}
            error={
              postError && postError.action === "update_user_basic"
                ? postError.error
                : undefined
            }
          />
        )
      }
      {
        finalTab === "personal" && (
          <PersonalInfoSection
            userId={userId}
            error={
              postError && (postError.action === "upsert_personal_info" || postError.action === "upload_user_image")
                ? postError.error
                : undefined
            }
          />
        )
      }
      {
        finalTab === "education" && (
          <EducationSection
            userId={userId}
            error={
              postError &&
              (postError.action === "add_education" ||
                postError.action === "update_education" ||
                postError.action === "delete_education")
                ? postError.error
                : undefined
            }
          />
        )
      }
      {
        finalTab === "experience" && (
          <ExperienceSection
            userId={userId}
            error={
              postError &&
              (postError.action === "add_experience" ||
                postError.action === "delete_experience")
                ? postError.error
                : undefined
            }
          />
        )
      }
      {
        finalTab === "certificates" && (
          <CertificatesSection
            userId={userId}
            error={
              postError &&
              (postError.action === "add_certificate" ||
                postError.action === "delete_certificate")
                ? postError.error
                : undefined
            }
          />
        )
      }
      {
        finalTab === "projects" && (
          <ProjectsSection
            userId={userId}
            error={
              postError &&
              (postError.action === "add_project" ||
                postError.action === "update_project" ||
                postError.action === "delete_project" ||
                postError.action === "upload_project_image")
                ? postError.error
                : undefined
            }
          />
        )
      }
      {
        finalTab === "skills" && (
          <SkillsSection
            userId={userId}
            error={
              postError &&
              (postError.action === "add_skill" ||
                postError.action === "delete_skill")
                ? postError.error
                : undefined
            }
          />
        )
      }
      {
        finalTab === "languages" && (
          <LanguagesSection
            userId={userId}
            error={
              postError &&
              (postError.action === "add_language" ||
                postError.action === "delete_language")
                ? postError.error
                : undefined
            }
          />
        )
      }
    </div>
  </div>
</AdminLayout>
