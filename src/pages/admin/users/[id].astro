---
import "@/styles/global.css";
import {
  db,
  users as Users,
  personal_info as PersonalInfo,
  education as Education,
  experience as Experience,
  certificates as Certificates,
  projects as Projects,
  languages as Languages,
  user_languages as UserLanguages,
  skills as Skills,
  eq,
} from "astro:db";
import { handleAdminUserPost } from "@/lib/adminUserActions";
import BasicSection from "@/components/sections/BasicSection.astro";
import PersonalInfoSection from "@/components/sections/PersonalInfoSection.astro";
import EducationSection from "@/components/sections/EducationSection.astro";
import ExperienceSection from "@/components/sections/ExperienceSection.astro";
import CertificatesSection from "@/components/sections/CertificatesSection.astro";
import ProjectsSection from "@/components/sections/ProjectsSection.astro";
import SkillsSection from "@/components/sections/SkillsSection.astro";
import LanguagesSection from "@/components/sections/LanguagesSection.astro";
import { parseExperienceRows } from "@/lib/schemas";

const userId = Number(Astro.params.id);
if (!Number.isFinite(userId)) {
  return Astro.redirect("/admin/users");
}

// Handle POST actions (create/update/delete)
if (Astro.request.method === "POST") {
  const form = await Astro.request.formData();
  try {
    await handleAdminUserPost(userId, form);
  } catch (e) {
    console.error(e);
  }
  return Astro.redirect(Astro.url.pathname);
}

// Fetch data for rendering
const [userRow] = await db.select().from(Users).where(eq(Users.id, userId));
if (!userRow) {
  return Astro.redirect("/admin/users");
}
const [pi] = await db
  .select()
  .from(PersonalInfo)
  .where(eq(PersonalInfo.user_id, userId));
const edu = await db
  .select()
  .from(Education)
  .where(eq(Education.user_id, userId));
const exp = await db
  .select()
  .from(Experience)
  .where(eq(Experience.user_id, userId));
// Validate and transform DB rows to component shape
const expItems = parseExperienceRows(exp);
const certs = await db
  .select()
  .from(Certificates)
  .where(eq(Certificates.user_id, userId));
const projects = await db
  .select()
  .from(Projects)
  .where(eq(Projects.user_id, userId));
const languages = await db.select().from(Languages);
const userLanguages = await db
  .select()
  .from(UserLanguages)
  .where(eq(UserLanguages.user_id, userId));
const userSkills = await db
  .select()
  .from(Skills)
  .where(eq(Skills.user_id, userId));
const availableSkills = Array.from(
  new Set(userSkills.map((s) => s.name).filter(Boolean)),
) as string[];
---

<div class="p-6 max-w-5xl mx-auto space-y-10">
  <div class="flex items-center justify-between">
    <h1 class="text-2xl font-semibold">Manage user #{userRow.id}</h1>
    <a href="/admin/users" class="text-fg-link hover:underline">Back to users</a
    >
  </div>

  <BasicSection userRow={userRow} />
  <PersonalInfoSection pi={pi} />
  <EducationSection edu={edu} />
  <ExperienceSection exp={expItems} availableSkills={availableSkills} />
  <CertificatesSection certs={certs} />
  <ProjectsSection projects={projects} />
  <SkillsSection userSkills={userSkills} />
  <LanguagesSection languages={languages} userLanguages={userLanguages} />
</div>
