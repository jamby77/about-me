---
import "@/styles/global.css";
import { db, users, personal_info as PersonalInfo } from "astro:db";
import UserAvatar from "@/components/UserAvatar.astro";

// Fetch all users from legacy `users` table
const rows = await db.select().from(users);
const piRows = await db.select().from(PersonalInfo);
const imageByUserId = new Map(piRows.map((pi) => [pi.user_id, pi.image]));

const list = rows.map((u) => ({
  id: u.id,
  name: `${u.first_name ?? ""} ${u.last_name ?? ""}`.trim() || "(no name)",
  email: u.email,
  image: imageByUserId.get(u.id) || null,
}));
---

<div class="p-6 max-w-4xl mx-auto">
  <div class="mb-6 flex items-center justify-between">
    <h1 class="text-2xl font-semibold">Users</h1>
    <a href="/admin" class="text-fg-link hover:underline">Back to admin</a>
  </div>

  {
    list.length === 0 ? (
      <p class="text-fg-subtle">No users found.</p>
    ) : (
      <ul class="divide-y rounded border">
        {list.map((u) => (
          <li class="p-4 flex items-center justify-between">
            <UserAvatar
              user={{ name: u.name, email: u.email, image: u.image }}
            />
            <a
              href={`/admin/users/${u.id}`}
              class="text-fg-link hover:underline"
            >
              Edit
            </a>
          </li>
        ))}
      </ul>
    )
  }
</div>
