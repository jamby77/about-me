---
import AdminLayout from "@/layouts/AdminLayout.astro";
import { db, users, personal_info as PersonalInfo } from "astro:db";
import UserAvatar from "@/components/UserAvatar.astro";

// Fetch all users from legacy `users` table
const rows = await db.select().from(users);
const piRows = await db.select().from(PersonalInfo);
const imageByUserId = new Map(piRows.map((pi) => [pi.user_id, pi.image]));

const list = rows.map((u) => ({
  id: u.id,
  name: `${u.first_name ?? ""} ${u.last_name ?? ""}`.trim() || "(no name)",
  email: u.email,
  image: imageByUserId.get(u.id) || null,
}));
---

<AdminLayout title="Users">
  <div class="bg-bg-surface rounded-lg shadow overflow-hidden">
    <div class="px-6 py-5 border-b border-bg-subtle">
      <h2 class="text-lg font-medium">User Management</h2>
      <p class="mt-1 text-sm text-fg-subtle">Edit users' data</p>
    </div>

    <div class="px-6 py-5">
      {
        list.length === 0 ? (
          <div class="text-center py-8">
            <p class="text-fg-subtle">No users found.</p>
          </div>
        ) : (
          <ul class="divide-y rounded border">
            {list.map((u) => (
              <li class="p-4 flex items-center justify-between">
                <UserAvatar
                  user={{ name: u.name, email: u.email, image: u.image }}
                />
                <a
                  href={`/admin/users/${u.id}`}
                  class="text-fg-link hover:underline"
                >
                  Edit
                </a>
              </li>
            ))}
          </ul>
        )
      }
    </div>
  </div>
</AdminLayout>
